---
- name: Run ctorgalson.macosbox role on macOS infrastructure.
  hosts: all
  gather_facts: true
  become: true
  tasks:
    - name: Load all default variables.
      include_vars:
        dir: ../defaults

    # Test ssh keys
    - name: Verify ssh directory exists and has correct properties.
      block:
        - name: Get information about ssh directory.
          stat:
            path: "{{ mb_ssh_dir }}"
          register: mb_test_ssh_dir

        - name: Use stat information to verify properties.
          assert:
            that:
              - "mb_test_ssh_dir.stat.exists"
              - "mb_test_ssh_dir.stat.isdir"
              - "mb_test_ssh_dir.stat.mode == mb_ssh_dir_mode"
              - "mb_test_ssh_dir.stat.pw_name == mb_user"
              - "mb_test_ssh_dir.stat.gr_name == mb_group"

    - name: Verify ssh keys exist and have correct properties.
      block:
        - name: First find the ssh keys.
          find:
            paths: "{{ mb_ssh_dir }}"
          register: mb_test_ssh_keys
