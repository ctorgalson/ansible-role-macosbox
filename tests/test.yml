---
- name: Run ctorgalson.macosbox role on macOS infrastructure.
  hosts: all
  gather_facts: true
  become: true
  tasks:
    - name: Load all default variables.
      include_vars:
        dir: ../defaults

    # Test ssh keys
    - name: Verify ssh directory exists and has correct properties.
      block:
        - name: Get information about ssh directory.
          stat:
            path: "{{ mb_ssh_dir }}"
          register: mb_test_ssh_dir_stat

        - name: Use stat information to verify properties.
          assert:
            that:
              - "mb_test_ssh_dir_stat.stat.exists"
              - "mb_test_ssh_dir_stat.stat.isdir"
              - "mb_test_ssh_dir_stat.stat.mode == mb_ssh_dir_mode"
              - "mb_test_ssh_dir_stat.stat.pw_name == mb_user"
              - "mb_test_ssh_dir_stat.stat.gr_name == mb_group"

    - name: Verify ssh keys exist and have correct properties.
      block:
        - name: First find the ssh keys.
          find:
            paths: "{{ mb_ssh_dir }}"
          register: mb_test_ssh_keys

        - name: Get information about the ssh keys.
          stat:
            path: "{{ key.path }}"
          loop: "{{ mb_test_ssh_keys.files }}"
          loop_control:
            loop_var: key
          register: mb_test_ssh_keys_stat

        - name: Debug mb_test_ssh_keys_stat
          debug:
            var: mb_test_ssh_keys_stat
